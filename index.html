<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | å°ˆæ¥­å®Œæ•´ç‰ˆ v1.0.5</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Quicksand:wght@500;700&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">

    <style>
        :root { --primary-color: #63b3b0; }
        body { background-color: #f8fafc; font-family: "Noto Sans TC", "Quicksand", sans-serif; height: 100dvh; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Ticket Styles */
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .ticket-divider { border-top: 2px dashed #e2e8f0; position: relative; }

        /* Animations */
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s ease-out; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        #map-container { height: 100%; width: 100%; z-index: 1; }
    </style>
</head>
<body class="text-slate-700 antialiased flex flex-col">

    <div id="app" class="h-full flex flex-col relative w-full">

        <header :style="{ backgroundColor: themeColor }" class="pt-4 pb-4 px-5 shadow-lg rounded-b-[1.5rem] z-20 shrink-0 text-white transition-colors duration-300">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h1 class="text-xl font-bold tracking-wide">{{ customTitle }}</h1>
                    <p class="text-[10px] opacity-80">{{ greetingMessage }}</p>
                </div>
                <div class="bg-white/20 hover:bg-white/30 p-2 rounded-full cursor-pointer transition-colors" @click="showSettingsModal = true">
                    <i class="ph ph-gear text-lg"></i>
                </div>
            </div>
            
            <div class="flex gap-3 mt-1" v-if="activeTab === 'home'">
                <div class="bg-white/20 backdrop-blur-md rounded-xl p-2 flex-1 text-center">
                    <div class="text-[9px] opacity-80">å³å°‡åˆ°ä¾†</div>
                    <div class="text-base font-bold">{{ upcomingCount }} å ´</div>
                </div>
                <div class="bg-white/20 backdrop-blur-md rounded-xl p-2 flex-1 text-center relative">
                    <div class="text-[9px] opacity-80">å¹´åº¦æ”¯å‡º</div>
                    <div class="text-base font-bold">{{ isPrivacyMode ? '****' : '$' + formatMoney(currentYearExpense) }}</div>
                    <button @click="isPrivacyMode = !isPrivacyMode" class="absolute top-1 right-1 opacity-50"><i class="ph" :class="isPrivacyMode ? 'ph-eye-slash' : 'ph-eye'"></i></button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar bg-slate-50 relative">
            
            <div v-if="activeTab === 'home'" class="p-5 pb-32 space-y-4">
                <div class="relative mb-2">
                    <i class="ph ph-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
                    <input v-model="searchQuery" type="text" placeholder="æœå°‹è—äººã€åœ°é»..." class="w-full bg-white border border-slate-200 rounded-xl py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-primary/30 outline-none">
                </div>

                <div class="flex bg-slate-200 p-1 rounded-full">
                    <button @click="viewMode = 'upcoming'" :class="viewMode === 'upcoming' ? 'bg-white text-primary shadow-sm' : 'text-slate-500'" class="flex-1 py-2 text-xs font-bold rounded-full transition-all">ğŸš€ å³å°‡åˆ°ä¾†</button>
                    <button @click="viewMode = 'history'" :class="viewMode === 'history' ? 'bg-white text-primary shadow-sm' : 'text-slate-500'" class="flex-1 py-2 text-xs font-bold rounded-full transition-all">ğŸ“¸ ç¾å¥½å›æ†¶</button>
                </div>

                <transition-group name="fade">
                    <div v-for="event in filteredEvents" :key="event.id" @click="toggleExpand(event.id)" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden relative active:scale-[0.98] transition-transform">
                        <div v-if="event.coverUrl" class="h-28 w-full bg-slate-200 relative">
                            <img :src="event.coverUrl" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                            <div class="absolute bottom-2 left-4 text-white">
                                <span class="text-[9px] bg-white/20 backdrop-blur-sm px-1.5 rounded">{{ event.artist }}</span>
                                <h3 class="font-bold text-base">{{ event.title }}</h3>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div v-if="!event.coverUrl" class="mb-2">
                                <span class="text-[10px] font-bold text-white px-2 py-0.5 rounded" :style="{ backgroundColor: event.color || themeColor }">{{ event.artist }}</span>
                                <h3 class="text-lg font-bold text-slate-800">{{ event.title }}</h3>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-xs text-slate-500">
                                <div class="flex items-center gap-1"><i class="ph ph-calendar"></i> {{ event.date }}</div>
                                <div class="flex items-center gap-1"><i class="ph ph-map-pin"></i> {{ event.location }}</div>
                                <div class="flex items-center gap-1"><i class="ph ph-chair"></i> {{ event.seat || 'ç„¡åº§ä½è³‡è¨Š' }}</div>
                                <div class="flex items-center gap-1 font-bold text-slate-700"><i class="ph ph-wallet"></i> ${{ formatMoney(calculateTotal(event.expenses)) }}</div>
                            </div>
                        </div>

                        <div v-if="expandedEventId === event.id" class="px-4 pb-4 border-t border-slate-50 bg-slate-50/50 space-y-3 pt-3">
                            <div v-if="event.checklist && event.checklist.length" class="space-y-1">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">æº–å‚™æ¸…å–®</p>
                                <div v-for="item in event.checklist" class="flex items-center gap-2 text-xs">
                                    <input type="checkbox" v-model="item.checked" class="rounded border-slate-300">
                                    <span :class="item.checked ? 'line-through text-slate-300' : ''">{{ item.text }}</span>
                                </div>
                            </div>
                            <div v-if="event.memo" class="space-y-1">
                                <p class="text-[10px] font-bold text-slate-400 uppercase">å¿ƒå¾—ç­†è¨˜</p>
                                <p class="text-xs text-slate-600 bg-white p-2 rounded-lg italic leading-relaxed">{{ event.memo }}</p>
                            </div>
                            <div class="flex gap-2">
                                <button @click.stop="showTicket(event)" class="flex-1 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><i class="ph ph-ticket"></i> æŸ¥çœ‹ç¥¨æ ¹</button>
                                <button @click.stop="editEvent(event)" class="py-2 px-4 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold"><i class="ph ph-pencil"></i></button>
                                <button @click.stop="deleteEvent(event.id)" class="py-2 px-4 bg-red-50 text-red-600 rounded-lg text-xs font-bold"><i class="ph ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </transition-group>
            </div>

            <div v-if="activeTab === 'fandom'" class="p-5 pb-32 space-y-4">
                <div v-for="(fan, index) in fandoms" :key="index" class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100 group">
                    <img v-if="fan.coverUrl" :src="fan.coverUrl" class="h-32 w-full object-cover">
                    <div class="p-4 flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold flex items-center gap-2">{{ fan.name }} <span class="text-2xl">{{ fan.sticker }}</span></h3>
                            <p class="text-sm text-slate-500">å…¥å‘ç¬¬ <span class="text-primary font-extrabold text-xl">{{ calculateFandomDays(fan.date) }}</span> å¤©</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="editFandom(fan, index)" class="p-2 text-slate-300 hover:text-blue-500"><i class="ph ph-pencil text-lg"></i></button>
                            <button @click="removeFandom(index)" class="p-2 text-slate-300 hover:text-red-500"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                    </div>
                </div>
                <button @click="openFandomModal" class="w-full py-8 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-slate-100 transition-colors">+ æ–°å¢å…¥å‘ç´€å¿µæ—¥</button>
            </div>

            <div v-show="activeTab === 'map'" class="h-full w-full relative">
                <div id="map-container"></div>
                <div class="absolute top-4 left-4 right-4 bg-white/90 backdrop-blur shadow-lg rounded-xl p-3 z-10 text-xs">
                    å·²è§£é– <b>{{ mappedEventsCount }}</b> å€‹è¿½æ˜Ÿè¶³è·¡ ğŸ“
                </div>
            </div>

            <div v-if="activeTab === 'stats'" class="p-5 pb-32 space-y-6">
                <div :class="['rounded-3xl p-6 text-white shadow-xl relative overflow-hidden bg-gradient-to-br transition-all duration-500', userLevelData.color]">
                    <div class="absolute -right-4 -top-4 opacity-10 rotate-12"><i class="ph ph-crown text-9xl"></i></div>
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-4xl shadow-inner">{{ userLevelData.icon }}</div>
                        <div class="flex-1">
                            <div class="flex items-baseline gap-2">
                                <h3 class="font-bold text-xl">{{ userLevelData.title }}</h3>
                                <span class="text-[10px] font-mono opacity-80 uppercase tracking-tighter">Level {{ userLevelData.level }}</span>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-[10px] mb-1 font-mono opacity-90">
                                    <span>EXP {{ userLevelData.totalXP }}</span>
                                    <span>Next +{{ userLevelData.nextLevelXP }}</span>
                                </div>
                                <div class="h-2 w-full bg-black/20 rounded-full overflow-hidden shadow-inner">
                                    <div class="h-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-1000" :style="{ width: userLevelData.progress + '%' }"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="ph ph-medal"></i> æˆå°±è§£é–</h3>
                    <div class="grid grid-cols-4 gap-3">
                        <div v-for="ach in achievements" class="flex flex-col items-center">
                            <div class="w-11 h-11 rounded-full flex items-center justify-center mb-1 shadow-sm" :style="{ backgroundColor: ach.color + '15', color: ach.color }">
                                <i :class="['ph text-2xl', ach.icon]"></i>
                            </div>
                            <span class="text-[9px] font-bold text-slate-500 text-center leading-tight">{{ ach.name }}</span>
                        </div>
                        <div v-if="achievements.length === 0" class="col-span-4 text-center py-4 text-xs text-slate-300 italic">å°šæœªè§£é–æˆå°±...</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">ç´¯è¨ˆå ´æ¬¡</p>
                        <p class="text-2xl font-bold">{{ events.length }} <span class="text-xs font-normal">å ´</span></p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">æœ¬å‘½è—äºº</p>
                        <p class="text-sm font-bold truncate">{{ topArtist.name || 'ç„¡' }}</p>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-100 px-4 py-2 flex justify-around items-center safe-pb z-40">
            <button v-for="tab in tabs" @click="activeTab = tab.id" :class="activeTab === tab.id ? '' : 'text-slate-300'" :style="{ color: activeTab === tab.id ? themeColor : '' }" class="flex flex-col items-center p-2 transition-all">
                <i :class="['ph text-2xl', activeTab === tab.id ? tab.icon + '-fill' : tab.icon]"></i>
                <span class="text-[9px] font-bold mt-0.5">{{ tab.label }}</span>
            </button>
        </nav>

        <button v-if="activeTab === 'home'" @click="openModal" :style="{ backgroundColor: themeColor }" class="fixed bottom-20 right-6 w-14 h-14 text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 active:scale-90 transition-transform shadow-primary/40">
            <i class="ph ph-plus"></i>
        </button>

        <transition name="slide-up">
            <div v-if="showModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-6 space-y-4 max-h-[92vh] overflow-y-auto no-scrollbar">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h2>
                        <button @click="showModal = false" class="text-slate-400 p-2"><i class="ph ph-x text-xl"></i></button>
                    </div>
                    
                    <div class="space-y-4 pb-10">
                        <div>
                            <label class="text-xs font-bold text-slate-400">å°é¢åœ–ç‰‡ (Base64/URL)</label>
                            <div v-if="form.coverUrl" class="mt-2 relative">
                                <img :src="form.coverUrl" class="h-32 w-full object-cover rounded-xl">
                                <button @click="form.coverUrl = ''" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1"><i class="ph ph-trash"></i></button>
                            </div>
                            <div v-else class="mt-2 flex gap-2">
                                <label class="flex-1 py-3 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center gap-2 text-xs text-slate-400 cursor-pointer">
                                    <i class="ph ph-image"></i> æª”æ¡ˆä¸Šå‚³
                                    <input type="file" @change="handleFileUpload($event, 'event')" accept="image/*" class="hidden">
                                </label>
                                <button @click="promptUrl('event')" class="px-4 py-3 bg-slate-100 rounded-xl text-xs font-bold"><i class="ph ph-link"></i></button>
                            </div>
                        </div>

                        <input v-model="form.title" type="text" placeholder="æ´»å‹•åç¨± (ä¾‹å¦‚: 2024 æ¼”å”±æœƒ)" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-primary/20 transition-all">
                        <div class="grid grid-cols-2 gap-4">
                            <input v-model="form.artist" type="text" placeholder="è—äººåç¨±" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-primary/20 transition-all">
                            <div class="flex items-center gap-2 bg-slate-50 p-3 rounded-2xl">
                                <span class="text-xs font-bold text-slate-400">ä¸»é¡Œè‰²</span>
                                <input v-model="form.color" type="color" class="h-8 w-full cursor-pointer bg-transparent border-none">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input v-model="form.date" type="date" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none">
                            <input v-model="form.time" type="time" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none">
                        </div>
                        
                        <div class="flex gap-2">
                            <input v-model="form.location" type="text" placeholder="åœ°é» (å¦‚: å°åŒ—å°å·¨è›‹)" class="flex-1 p-4 bg-slate-50 border-none rounded-2xl outline-none">
                            <button @click="searchCoordinates" class="px-4 bg-blue-50 text-blue-500 rounded-2xl"><i class="ph ph-crosshair"></i></button>
                        </div>
                        <p v-if="searchError" class="text-[10px] text-red-400 pl-2">{{ searchError }}</p>

                        <input v-model="form.seat" type="text" placeholder="åº§ä½è³‡è¨Š (ä¾‹å¦‚: Aå€ 12æ’)" class="w-full p-4 bg-slate-50 border-none rounded-2xl outline-none">
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-slate-400">æ”¯å‡ºæ˜ç´°</label>
                                <span class="text-xs font-bold text-primary">${{ calculateTotal(form.expenses) }}</span>
                            </div>
                            <div v-for="(exp, idx) in form.expenses" class="flex gap-2 mb-2">
                                <input v-model="exp.item" type="text" placeholder="é …ç›®" class="flex-1 p-3 bg-slate-50 rounded-xl text-sm border-none outline-none">
                                <input v-model.number="exp.amount" type="number" placeholder="é‡‘é¡" class="w-24 p-3 bg-slate-50 rounded-xl text-sm border-none outline-none">
                                <button @click="form.expenses.splice(idx, 1)" class="text-red-400"><i class="ph ph-minus-circle"></i></button>
                            </div>
                            <button @click="form.expenses.push({item:'', amount:0})" class="w-full py-2 bg-slate-100 rounded-xl text-[10px] font-bold text-slate-500">+ æ–°å¢æ”¯å‡º</button>
                        </div>

                        <textarea v-model="form.memo" placeholder="å¯«ä¸‹å¿ƒæƒ…ç­†è¨˜ (æ»¿ 20 å­—æœ‰é¡å¤– XP çå‹µï¼)" class="w-full p-4 bg-slate-50 border-none rounded-2xl h-28 outline-none focus:ring-2 focus:ring-primary/20 transition-all text-sm"></textarea>
                        
                        <button @click="saveEvent" :style="{ backgroundColor: themeColor }" class="w-full py-4 text-white font-bold rounded-2xl shadow-lg active:scale-95 transition-transform">å„²å­˜è¡Œç¨‹</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showSettingsModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 p-6 backdrop-blur-sm">
                <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs space-y-6">
                    <h3 class="font-bold text-lg text-center">App è¨­å®š âš™ï¸</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">App æ¨™é¡Œ</label>
                            <input v-model="customTitle" class="w-full p-2 bg-slate-50 rounded-lg text-sm mt-1 outline-none border-b-2 border-primary/20">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-400 uppercase">ä¸»é¡Œè‰²å½©</label>
                            <div class="flex gap-2 mt-2">
                                <div v-for="c in ['#63b3b0', '#ff6b6b', '#feca57', '#5f27cd']" @click="themeColor = c" :style="{backgroundColor: c}" class="w-8 h-8 rounded-full cursor-pointer border-2" :class="themeColor === c ? 'border-black' : 'border-transparent'"></div>
                                <input type="color" v-model="themeColor" class="w-8 h-8 rounded-full cursor-pointer bg-transparent border-none p-0">
                            </div>
                        </div>
                        <div class="pt-4 border-t space-y-2">
                            <button @click="downloadBackup" class="w-full py-2 bg-slate-100 rounded-xl text-xs font-bold flex items-center justify-center gap-2"><i class="ph ph-download"></i> å‚™ä»½è³‡æ–™ (JSON)</button>
                            <label class="w-full py-2 bg-slate-100 rounded-xl text-xs font-bold flex items-center justify-center gap-2 cursor-pointer">
                                <i class="ph ph-upload"></i> é‚„åŸè³‡æ–™
                                <input type="file" @change="restoreBackup" class="hidden" accept=".json">
                            </label>
                        </div>
                    </div>
                    <button @click="showSettingsModal = false" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">å®Œæˆ</button>
                </div>
            </div>
        </transition>

        <transition name="slide-up">
            <div v-if="showFandomModal" class="fixed inset-0 z-[60] flex items-end justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white w-full max-w-md rounded-t-[2.5rem] p-6 space-y-4">
                    <h2 class="text-xl font-bold">{{ isFandomEditing ? 'ç·¨è¼¯å…¥å‘æ—¥' : 'æ–°å¢å…¥å‘æ—¥' }}</h2>
                    <input v-model="fandomForm.name" placeholder="è—äººåç¨±" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                    <input v-model="fandomForm.date" type="date" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                    <input v-model="fandomForm.sticker" placeholder="Emoji (å¦‚: âœ¨)" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                    <div>
                        <label class="text-xs font-bold text-slate-400">å°é¢åœ–</label>
                        <input type="file" @change="handleFileUpload($event, 'fandom')" class="block w-full text-xs mt-1">
                    </div>
                    <button @click="saveFandom" :style="{ backgroundColor: themeColor }" class="w-full py-4 text-white font-bold rounded-2xl">å„²å­˜</button>
                    <button @click="showFandomModal = false" class="w-full text-sm text-slate-400">å–æ¶ˆ</button>
                </div>
            </div>
        </transition>

        <transition name="fade">
            <div v-if="showTicketModal" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-6" @click="showTicketModal = false">
                <div class="w-full max-w-xs ticket-stub bg-white rounded-3xl overflow-hidden text-slate-800" @click.stop>
                    <div class="h-24 bg-primary relative" :style="{backgroundColor: ticketEvent.color || themeColor}">
                        <img v-if="ticketEvent.coverUrl" :src="ticketEvent.coverUrl" class="w-full h-full object-cover opacity-50">
                        <div class="absolute inset-0 flex items-center justify-center"><h2 class="text-2xl font-black text-white uppercase tracking-widest">{{ ticketEvent.artist }}</h2></div>
                    </div>
                    <div class="p-6 text-center space-y-4">
                        <div><p class="text-[9px] text-slate-400 uppercase tracking-widest">Event Title</p><h3 class="font-bold text-lg leading-tight">{{ ticketEvent.title }}</h3></div>
                        <div class="grid grid-cols-2 border-y border-slate-50 py-4">
                            <div class="text-left"><p class="text-[9px] text-slate-400 uppercase">Date</p><p class="text-xs font-bold">{{ ticketEvent.date }}</p></div>
                            <div class="text-right"><p class="text-[9px] text-slate-400 uppercase">Location</p><p class="text-xs font-bold">{{ ticketEvent.location }}</p></div>
                        </div>
                        <div class="flex justify-between">
                            <div class="text-left"><p class="text-[9px] text-slate-400 uppercase">Seat</p><p class="text-xs font-bold text-primary" :style="{color: ticketEvent.color || themeColor}">{{ ticketEvent.seat || 'GA' }}</p></div>
                            <div class="text-right"><p class="text-[9px] text-slate-400 uppercase">Price</p><p class="text-xs font-bold">${{ formatMoney(calculateTotal(ticketEvent.expenses)) }}</p></div>
                        </div>
                        <div class="pt-4"><div class="font-barcode text-5xl opacity-80">{{ ticketEvent.id ? ticketEvent.id.toString().slice(-8) : '00000000' }}</div></div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // è³‡æ–™ç‹€æ…‹
                const events = ref(JSON.parse(localStorage.getItem('idolEvents') || '[]'));
                const fandoms = ref(JSON.parse(localStorage.getItem('fandomFandoms') || '[]'));
                const themeColor = ref(localStorage.getItem('idolTheme') || '#63b3b0');
                const customTitle = ref(localStorage.getItem('appTitle') || 'è¿½æ˜Ÿæ—¥è¨˜ âœ¨');
                const isPrivacyMode = ref(false);
                const activeTab = ref('home');
                const viewMode = ref('upcoming');
                const searchQuery = ref('');
                const expandedEventId = ref(null);
                
                // å½ˆçª—ç‹€æ…‹
                const showModal = ref(false);
                const showSettingsModal = ref(false);
                const showFandomModal = ref(false);
                const showTicketModal = ref(false);
                const isEditing = ref(false);
                const isFandomEditing = ref(false);
                const editFandomIndex = ref(null);
                const searchError = ref('');
                
                // è¡¨å–®ç‹€æ…‹
                const form = ref({ id: null, title: '', artist: '', date: '', time: '19:00', location: '', seat: '', color: '', expenses: [{item:'é–€ç¥¨', amount:0}], memo: '', coverUrl: '', lat: null, lng: null });
                const fandomForm = ref({ name: '', date: '', sticker: 'âœ¨', coverUrl: '' });
                const ticketEvent = ref({});

                const tabs = [
                    { id: 'home', label: 'è¡Œç¨‹', icon: 'ph-calendar-check' },
                    { id: 'fandom', label: 'ç´€å¿µæ—¥', icon: 'ph-heart' },
                    { id: 'map', label: 'åœ°åœ–', icon: 'ph-map-trifold' },
                    { id: 'stats', label: 'å›é¡§', icon: 'ph-chart-bar' }
                ];

                // --- ç­‰ç´šèˆ‡ XP ç®—æ³• ---
                const userLevelData = computed(() => {
                    let xp = 0;
                    xp += events.value.length * 100; // åŸºç¤å ´æ¬¡
                    xp += new Set(events.value.map(e => e.artist)).size * 50; // å¤šæ¨£æ€§
                    xp += new Set(events.value.map(e => e.location)).size * 50; // åœ°åœ–è¶³è·¡
                    
                    events.value.forEach(e => {
                        if (e.memo && e.memo.length > 20) xp += 30; // å…§å®¹çå‹µ
                    });
                    
                    fandoms.value.forEach(f => {
                        const years = Math.floor(calculateFandomDays(f.date) / 365);
                        xp += years * 200; // è³‡æ·±çå‹µ
                    });

                    const lv = Math.max(1, Math.floor(Math.sqrt(xp / 100)));
                    const baseXP = Math.pow(lv, 2) * 100;
                    const nextXP = Math.pow(lv + 1, 2) * 100;
                    const prog = ((xp - baseXP) / (nextXP - baseXP)) * 100;

                    const ranks = [
                        { lv: 40, title: "å‚³å¥‡å¤§ç ²æ‰‹", icon: "ğŸ“¸", color: "from-purple-600 to-pink-500" },
                        { lv: 20, title: "éˆé­‚æ‡‰æ´å®¶", icon: "ğŸ’", color: "from-blue-500 to-cyan-400" },
                        { lv: 10, title: "å ´é¤¨å·¡èˆªå“¡", icon: "ğŸš€", color: "from-amber-500 to-orange-400" },
                        { lv: 4,  title: "æ‡‰æ´å°éšŠé•·", icon: "ğŸ“£", color: "from-emerald-500 to-teal-400" },
                        { lv: 0,  title: "è¦‹ç¿’è¿½æ˜Ÿäºº", icon: "ğŸŒ±", color: "from-slate-600 to-slate-500" }
                    ];
                    const currentRank = ranks.find(r => lv >= r.lv);
                    return { level: lv, totalXP: xp, progress: Math.min(prog, 100), nextLevelXP: nextXP - xp, ...currentRank };
                });

                // --- æˆå°±åµæ¸¬ ---
                const achievements = computed(() => {
                    const list = [];
                    const allE = events.value;
                    if (allE.length >= 1) list.push({ name: 'åˆå¿ƒè¦‹è­‰', icon: 'ph-sparkle', color: '#63b3b0' });
                    if (new Set(allE.map(e => e.location)).size >= 5) list.push({ name: 'è¶³è·¡éé‡', icon: 'ph-map-pin', color: '#ff6b6b' });
                    if (allE.some(e => calculateTotal(e.expenses) >= 10000)) list.push({ name: 'å¤§è±ªå®¢', icon: 'ph-money', color: '#feca57' });
                    if (allE.length >= 20) list.push({ name: 'å…¨å‹¤å‹æ¨¡', icon: 'ph-clock-countdown', color: '#5f27cd' });
                    if (fandoms.value.length >= 3) list.push({ name: 'åšæ„›åšæ„›', icon: 'ph-users-three', color: '#48dbfb' });
                    return list;
                });

                // --- æ•¸æ“šçµ±è¨ˆ ---
                const filteredEvents = computed(() => {
                    const query = searchQuery.value.toLowerCase();
                    const today = new Date().toISOString().split('T')[0];
                    let list = events.value.filter(e => e.title.toLowerCase().includes(query) || e.artist.toLowerCase().includes(query));
                    if (viewMode.value === 'upcoming') return list.filter(e => e.date >= today).sort((a,b)=>new Date(a.date)-new Date(b.date));
                    return list.filter(e => e.date < today).sort((a,b)=>new Date(b.date)-new Date(a.date));
                });

                const upcomingCount = computed(() => events.value.filter(e => e.date >= new Date().toISOString().split('T')[0]).length);
                const currentYearExpense = computed(() => {
                    const year = new Date().getFullYear();
                    return events.value.filter(e => e.date.startsWith(year.toString())).reduce((sum, e) => sum + calculateTotal(e.expenses), 0);
                });
                const topArtist = computed(() => {
                    const counts = {};
                    events.value.forEach(e => counts[e.artist] = (counts[e.artist] || 0) + 1);
                    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                    return sorted.length ? { name: sorted[0][0], count: sorted[0][1] } : { name: null };
                });
                const mappedEventsCount = computed(() => events.value.filter(e => e.lat).length);

                // --- æ–¹æ³• ---
                const formatMoney = (v) => v ? v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0';
                const calculateTotal = (exps) => exps ? exps.reduce((s, i) => s + (Number(i.amount) || 0), 0) : 0;
                const calculateFandomDays = (date) => {
                    if (!date) return 0;
                    const diff = new Date() - new Date(date);
                    return Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)) + 1);
                };

                const toggleExpand = (id) => expandedEventId.value = (expandedEventId.value === id) ? null : id;
                const openModal = () => {
                    isEditing.value = false;
                    form.value = { id: null, title: '', artist: '', date: new Date().toISOString().split('T')[0], time: '19:00', location: '', seat: '', color: '', expenses: [{item:'é–€ç¥¨', amount:0}], memo: '', coverUrl: '', lat: null, lng: null };
                    showModal.value = true;
                };

                const saveEvent = () => {
                    if (!form.value.title || !form.value.date) return alert('æ´»å‹•åç¨±èˆ‡æ—¥æœŸå¿…å¡«å–”ï¼');
                    if (isEditing.value) {
                        const idx = events.value.findIndex(e => e.id === form.value.id);
                        events.value[idx] = JSON.parse(JSON.stringify(form.value));
                    } else {
                        events.value.push({ ...form.value, id: Date.now() });
                    }
                    showModal.value = false;
                };

                const deleteEvent = (id) => { if(confirm('è¦åˆªé™¤é€™å ´å›æ†¶å—ï¼Ÿ')) events.value = events.value.filter(e => e.id !== id); };
                const editEvent = (evt) => { isEditing.value = true; form.value = JSON.parse(JSON.stringify(evt)); showModal.value = true; };

                const openFandomModal = () => { isFandomEditing.value = false; fandomForm.value = { name: '', date: '', sticker: 'âœ¨', coverUrl: '' }; showFandomModal.value = true; };
                const saveFandom = () => {
                    if (isFandomEditing.value) fandoms.value[editFandomIndex.value] = JSON.parse(JSON.stringify(fandomForm.value));
                    else fandoms.value.push(JSON.parse(JSON.stringify(fandomForm.value)));
                    showFandomModal.value = false;
                };
                const editFandom = (fan, idx) => { isFandomEditing.value = true; editFandomIndex.value = idx; fandomForm.value = JSON.parse(JSON.stringify(fan)); showFandomModal.value = true; };
                const removeFandom = (idx) => { if(confirm('ä¸è¿½äº†å—ï¼ŸğŸ˜­')) fandoms.value.splice(idx, 1); };

                const showTicket = (evt) => { ticketEvent.value = evt; showTicketModal.value = true; };

                // åœ°åœ–èˆ‡å®šä½
                let map = null;
                const initMap = () => {
                    if (map) return map.invalidateSize();
                    map = L.map('map-container').setView([23.6, 121], 7);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    events.value.filter(e => e.lat).forEach(e => {
                        L.circleMarker([e.lat, e.lng], { radius: 8, color: e.color || themeColor.value, fillOpacity: 0.8 }).addTo(map).bindPopup(`<b>${e.artist}</b><br>${e.title}`);
                    });
                };

                const searchCoordinates = async () => {
                    if (!form.value.location) return;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(form.value.location)}&limit=1`);
                        const data = await res.json();
                        if (data[0]) {
                            form.value.lat = parseFloat(data[0].lat);
                            form.value.lng = parseFloat(data[0].lon);
                            searchError.value = "å®šä½æˆåŠŸï¼";
                        } else { searchError.value = "æ‰¾ä¸åˆ°è©²åœ°é»..."; }
                    } catch (e) { searchError.value = "ç¶²è·¯éŒ¯èª¤"; }
                };

                // Base64 ä¸Šå‚³
                const handleFileUpload = (event, type) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    if (file.size > 1024 * 1024) return alert("åœ–ç‰‡å¤ªå¤§å›‰ (é™ 1MB)");
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (type === 'event') form.value.coverUrl = e.target.result;
                        else fandomForm.value.coverUrl = e.target.result;
                    };
                    reader.readAsDataURL(file);
                };

                const promptUrl = (type) => {
                    const url = prompt("è«‹è²¼ä¸Šåœ–ç‰‡é€£çµ:");
                    if (url) {
                        if (type === 'event') form.value.coverUrl = url;
                        else fandomForm.value.coverUrl = url;
                    }
                };

                // å‚™ä»½
                const downloadBackup = () => {
                    const blob = new Blob([JSON.stringify({events: events.value, fandoms: fandoms.value})], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `my_idol_tracker_backup.json`;
                    a.click();
                };
                const restoreBackup = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (res) => {
                        const data = JSON.parse(res.target.result);
                        if (data.events) {
                            events.value = data.events;
                            fandoms.value = data.fandoms;
                            alert("é‚„åŸæˆåŠŸï¼");
                        }
                    };
                    reader.readAsText(file);
                };

                // Watchers
                watch(events, (v) => localStorage.setItem('idolEvents', JSON.stringify(v)), {deep: true});
                watch(fandoms, (v) => localStorage.setItem('fandomFandoms', JSON.stringify(v)), {deep: true});
                watch(themeColor, (v) => localStorage.setItem('idolTheme', v));
                watch(customTitle, (v) => localStorage.setItem('appTitle', v));
                watch(activeTab, (t) => { if(t === 'map') nextTick(() => initMap()); });

                return {
                    events, fandoms, themeColor, customTitle, isPrivacyMode, activeTab, viewMode, searchQuery, expandedEventId,
                    showModal, showSettingsModal, showFandomModal, showTicketModal, isEditing, isFandomEditing, searchError,
                    form, fandomForm, ticketEvent, tabs, userLevelData, achievements, filteredEvents, upcomingCount, currentYearExpense, topArtist, mappedEventsCount,
                    formatMoney, calculateTotal, calculateFandomDays, toggleExpand, openModal, saveEvent, deleteEvent, editEvent,
                    openFandomModal, saveFandom, editFandom, removeFandom, showTicket, searchCoordinates, handleFileUpload, promptUrl, downloadBackup, restoreBackup,
                    greetingMessage: "è¿½æ˜Ÿæ˜¯é€šå¾€å¹¸ç¦çš„æ·å¾‘ ğŸ’–"
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
