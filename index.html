<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | è¿½æ˜Ÿè¡Œç¨‹ç®¡ç†ã€è²»ç”¨ç´€éŒ„èˆ‡åœ°åœ–è¶³è·¡</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Quicksand:wght@500;700&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: 'var(--primary-color)', 'primary-dark': 'var(--primary-dark)', 'primary-light': 'var(--primary-light)' },
                    fontFamily: { sans: ['"Noto Sans TC"', '"Quicksand"', 'sans-serif'], barcode: ['"Libre Barcode 39 Text"', 'cursive'] }
                }
            }
        }
    </script>

    <style>
        :root { --primary-color: #63b3b0; --primary-dark: #4a8f8c; --primary-light: #e0f2f1; }
        body { background-color: #f8fafc; height: 100dvh; width: 100vw; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* ç¥¨æ ¹æ¨£å¼ä¿®å¾© */
        .ticket-outer { width: 320px; background: white; border-radius: 24px; overflow: hidden; position: relative; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15)); }
        .ticket-header { height: 120px; background-size: cover; background-position: center; position: relative; display: flex; align-items: center; justify-content: center; }
        .ticket-header::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.2), rgba(0,0,0,0.5)); }
        .ticket-body { padding: 24px; background: white; position: relative; z-index: 10; }
        .ticket-side-cut { position: absolute; top: 0; width: 24px; height: 24px; background: #1a1a1a; border-radius: 50%; z-index: 20; }
        .ticket-divider { border-top: 2px dashed #e2e8f0; position: relative; margin: 12px 0; }
    </style>
</head>
<body class="text-slate-700">

    <div id="app" :style="cssVars" class="h-full flex flex-col relative w-full">

        <header :class="headerTextColor" class="pt-4 pb-4 px-5 shadow-lg rounded-b-[1.5rem] z-20 shrink-0" :style="{ backgroundColor: themeColor }">
            <div class="flex justify-between items-center mb-3">
                <div>
                    <h1 class="text-xl font-bold tracking-wide">{{ customTitle }}</h1>
                    <p class="text-xs opacity-90">{{ greetingMessage }}</p>
                </div>
                <div class="p-2 rounded-full backdrop-blur-sm cursor-pointer" @click="toggleSettingsModal">
                    <i class="ph ph-gear text-lg"></i>
                </div>
            </div>
            <div class="flex gap-3 mt-1" v-if="activeTab === 'home'">
                <div class="bg-white/20 backdrop-blur-md rounded-xl p-2.5 flex-1 text-center">
                    <div class="text-[10px] mb-0.5">å³å°‡åˆ°ä¾†</div>
                    <div class="text-lg font-bold">{{ upcomingCount }} å ´</div>
                </div>
                <div class="bg-white/20 backdrop-blur-md rounded-xl p-2.5 flex-1 text-center relative">
                    <div class="text-[10px] mb-0.5">å¹´åº¦èŠ±è²»</div>
                    <div class="text-lg font-bold">{{ isPrivacyMode ? '****' : '$' + formatMoney(currentYearExpense) }}</div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar scroll-smooth w-full relative bg-slate-50">
            <div v-if="activeTab === 'home'" class="space-y-4 p-5 pb-32">
                <div class="flex bg-slate-200 p-1 rounded-full relative mb-2">
                    <button @click="viewMode = 'upcoming'" class="flex-1 py-2 text-sm font-medium z-10" :class="viewMode === 'upcoming' ? 'text-primary' : 'text-slate-500'">å³å°‡åˆ°ä¾†</button>
                    <button @click="viewMode = 'history'" class="flex-1 py-2 text-sm font-medium z-10" :class="viewMode === 'history' ? 'text-primary' : 'text-slate-500'">ç¾å¥½å›æ†¶</button>
                </div>
                <div v-for="event in filteredEvents" :key="event.id" class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div v-if="event.coverUrl" class="h-32 w-full relative cursor-pointer" @click="toggleExpand(event.id)">
                        <img :src="event.coverUrl" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 flex items-end p-4 text-white font-bold">{{ event.title }}</div>
                    </div>
                    <div class="p-4 flex justify-between items-center cursor-pointer" @click="toggleExpand(event.id)">
                        <div><span class="text-xs font-bold text-primary">{{ event.artist }}</span><p class="font-bold">{{ event.date }}</p></div>
                        <button @click.stop="showTicket(event)" class="bg-slate-100 px-4 py-1 rounded-full text-xs font-bold">ç¥¨æ ¹</button>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'fandom'" class="space-y-4 p-5 pb-32">
                <div v-for="(fan, index) in fandoms" :key="index" class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div v-if="fan.coverUrl" class="h-40 w-full"><img :src="fan.coverUrl" class="w-full h-full object-cover"></div>
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-4">
                            <div><h3 class="text-xl font-bold">{{ fan.name }} {{ fan.sticker }}</h3><p class="text-xs text-slate-400">å…¥å‘æ—¥: {{ fan.date }}</p></div>
                            <button @click="removeFandom(index)" class="text-red-400"><i class="ph ph-trash text-lg"></i></button>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4 text-center border border-dashed">
                            <p class="text-sm text-slate-600">
                                å·²ç¶“æ„›äº† 
                                <span class="text-3xl font-black text-primary block my-1">{{ calculateFandomDays(fan.date) }}</span> 
                                å€‹é–ƒè€€çš„æ—¥å­ï¼âœ¨
                            </p>
                        </div>
                    </div>
                </div>
                <button @click="openFandomModal" class="w-full py-4 border-2 border-dashed rounded-2xl text-slate-400 font-bold">+ æ–°å¢å…¥å‘ç´€å¿µæ—¥</button>
            </div>

            <div v-if="activeTab === 'stats'" class="p-5 pb-32 space-y-4">
                <div class="flex justify-between items-center"><h2 class="text-xl font-bold">è¿½æ˜Ÿå›é¡§ ğŸ“Š</h2><button @click="generateReviewImage" class="bg-primary text-white px-4 py-1 rounded-full text-xs font-bold shadow-lg">åˆ†äº«æˆªåœ–</button></div>
                <div id="stats-capture" class="bg-white p-6 rounded-3xl shadow-sm border space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-4 rounded-2xl"><p class="text-[10px] text-slate-400">ç´¯è¨ˆå ´æ¬¡</p><p class="text-2xl font-black">{{ statsData.count }} æ¬¡</p></div>
                        <div class="bg-slate-50 p-4 rounded-2xl"><p class="text-[10px] text-slate-400">ç´¯è¨ˆèŠ±è²»</p><p class="text-2xl font-black">${{ formatMoney(statsData.totalSpent) }}</p></div>
                    </div>
                    <div><h3 class="text-sm font-bold mb-3"># æœ¬å‘½æ’è¡Œæ¦œ</h3>
                        <div v-for="(art, i) in statsData.topArtists" :key="i" class="flex justify-between items-center mb-2"><span class="text-sm font-medium">#{{i+1}} {{ art.name }}</span><span class="text-xs bg-primary-light text-primary font-bold px-2 py-0.5 rounded-full">{{ art.count }} æ¬¡</span></div>
                    </div>
                </div>
            </div>

            <div v-show="activeTab === 'map'" id="map-container" class="w-full h-full"></div>
        </main>

        <nav class="bg-white border-t px-6 py-3 flex justify-between items-center safe-pb">
            <button @click="activeTab = 'home'" :class="activeTab === 'home' ? 'text-primary' : 'text-slate-400'"><i class="ph ph-calendar-check text-2xl" :class="activeTab === 'home' ? 'ph-fill' : 'ph-bold'"></i><p class="text-[10px] font-bold">è¡Œç¨‹</p></button>
            <button @click="activeTab = 'fandom'" :class="activeTab === 'fandom' ? 'text-primary' : 'text-slate-400'"><i class="ph ph-heart text-2xl" :class="activeTab === 'fandom' ? 'ph-fill' : 'ph-bold'"></i><p class="text-[10px] font-bold">ç´€å¿µ</p></button>
            <button @click="activeTab = 'map'" :class="activeTab === 'map' ? 'text-primary' : 'text-slate-400'"><i class="ph ph-map-trifold text-2xl" :class="activeTab === 'map' ? 'ph-fill' : 'ph-bold'"></i><p class="text-[10px] font-bold">è¶³è·¡</p></button>
            <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'text-primary' : 'text-slate-400'"><i class="ph ph-chart-bar text-2xl" :class="activeTab === 'stats' ? 'ph-fill' : 'ph-bold'"></i><p class="text-[10px] font-bold">æ•¸æ“š</p></button>
        </nav>

        <transition name="fade">
            <div v-if="showTicketModal" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm p-4" @click.self="showTicketModal = false">
                <div id="ticket-capture" class="ticket-outer">
                    <div class="ticket-header" :style="{ backgroundImage: ticketEvent.coverUrl ? `url(${ticketEvent.coverUrl})` : 'none', backgroundColor: getEventColor(ticketEvent) }">
                        <h2 class="relative z-10 text-white font-black text-2xl tracking-widest drop-shadow-md text-center px-4">{{ ticketEvent.artist }}</h2>
                    </div>
                    <div class="ticket-body">
                        <div class="ticket-side-cut -left-3"></div><div class="ticket-side-cut -right-3"></div>
                        <div class="text-center mb-6"><p class="text-[10px] text-slate-400 uppercase tracking-[0.2em] mb-1">Event</p><h3 class="text-xl font-black leading-tight">{{ ticketEvent.title }}</h3></div>
                        <div class="grid grid-cols-2 gap-4 border-y border-slate-100 py-4 mb-4">
                            <div class="text-left"><p class="text-[10px] text-slate-400 mb-1">DATE / TIME</p><p class="font-bold text-sm">{{ ticketEvent.date }}</p><p class="font-bold text-sm">{{ ticketEvent.time }}</p></div>
                            <div class="text-right"><p class="text-[10px] text-slate-400 mb-1">LOCATION</p><p class="font-bold text-sm truncate">{{ ticketEvent.location }}</p></div>
                        </div>
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-left"><p class="text-[10px] text-slate-400 mb-1">SEAT</p><p class="font-black text-primary text-lg">{{ ticketEvent.seat || 'N/A' }}</p></div>
                            <div class="text-right"><p class="text-[10px] text-slate-400 mb-1">PRICE</p><p class="font-black text-slate-800 text-lg">${{ formatMoney(getTicketPrice(ticketEvent.expenses)) }}</p></div>
                        </div>
                        <div class="ticket-divider"></div>
                        <div class="pt-4 text-center">
                            <div class="font-barcode text-5xl text-slate-700 leading-none mb-2">{{ ticketEvent.id?.slice(-8) || '00000000' }}</div>
                            <p class="text-[9px] text-slate-300 font-bold tracking-widest">IDOL TRACKER EXCLUSIVE TICKET</p>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex gap-4">
                    <button @click="downloadTicketImage" class="bg-white text-slate-800 px-6 py-3 rounded-full font-black shadow-xl flex items-center gap-2 active:scale-95 transition-transform"><i class="ph ph-download"></i> å„²å­˜ç¥¨æ ¹åœ–ç‰‡</button>
                    <button @click="showTicketModal = false" class="bg-white/10 text-white px-6 py-3 rounded-full font-bold backdrop-blur-sm">é—œé–‰</button>
                </div>
            </div>
        </transition>

        <transition name="slide-up">
            <div v-if="showFandomModal" class="fixed inset-0 z-50 flex items-end justify-center">
                <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" @click="closeFandomModal"></div>
                <div class="bg-white w-full max-w-md rounded-t-3xl p-6 relative shadow-2xl">
                    <h2 class="text-xl font-bold mb-4">è¨˜éŒ„å…¥å‘æ—¥</h2>
                    <div class="space-y-4 mb-6">
                        <div><label class="text-xs text-slate-400">å¶åƒåç¨±</label><input v-model="fandomForm.name" class="w-full bg-slate-100 rounded-xl p-3"></div>
                        <div><label class="text-xs text-slate-400">å…¥å‘æ—¥æœŸ (YYYY-MM-DD)</label><input v-model="fandomForm.date" type="date" class="w-full bg-slate-100 rounded-xl p-3"></div>
                        <div><label class="text-xs text-slate-400">å°é¢åœ–ç‰‡ (Base64/URL)</label><input v-model="fandomForm.coverUrl" class="w-full bg-slate-100 rounded-xl p-3"></div>
                    </div>
                    <button @click="addFandom" class="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg">å„²å­˜</button>
                </div>
            </div>
        </transition>

        <div v-if="showSettingsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm" @click.self="showSettingsModal = false">
            <div class="bg-white p-6 rounded-3xl shadow-2xl w-80 text-center">
                <h3 class="font-bold mb-4">ç³»çµ±è¨­å®š âš™ï¸</h3>
                <button @click="downloadBackup" class="w-full py-3 bg-slate-100 rounded-xl mb-2 text-sm font-bold">å‚™ä»½è³‡æ–™ (JSON)</button>
                <button @click="showSettingsModal = false" class="mt-4 text-slate-400 text-xs">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        createApp({
            setup() {
                const events = ref(JSON.parse(localStorage.getItem('idolEvents') || '[]'));
                const fandoms = ref(JSON.parse(localStorage.getItem('fandomFandoms') || '[]'));
                const activeTab = ref('home');
                const viewMode = ref('upcoming');
                const themeColor = ref(localStorage.getItem('idolTheme') || '#63b3b0');
                const showTicketModal = ref(false);
                const showFandomModal = ref(false);
                const showSettingsModal = ref(false);
                const ticketEvent = ref({});
                const isPrivacyMode = ref(false);
                const customTitle = ref(localStorage.getItem('appTitle') || 'è¿½æ˜Ÿæ—¥è¨˜ âœ¨');
                const fandomForm = ref({ name: '', date: '', sticker: 'ğŸ’–', coverUrl: '' });
                let map = null;

                const cssVars = computed(() => ({ '--primary-color': themeColor.value }));
                const headerTextColor = computed(() => 'text-white');
                const greetingMessage = "ä»Šå¤©ä¹Ÿè¦åŠªåŠ›ç”Ÿæ´»å»è¦‹ä»– âœ¨";

                const filteredEvents = computed(() => {
                    const today = new Date().toISOString().split('T')[0];
                    return events.value.filter(e => viewMode.value === 'upcoming' ? e.date >= today : e.date < today).sort((a,b) => new Date(a.date) - new Date(b.date));
                });

                const statsData = computed(() => {
                    const spent = events.value.reduce((s, e) => s + (e.expenses?.reduce((acc, i) => acc + Number(i.amount), 0) || 0), 0);
                    const arts = {};
                    events.value.forEach(e => { arts[e.artist] = (arts[e.artist] || 0) + 1; });
                    const top = Object.keys(arts).map(k => ({name: k, count: arts[k]})).sort((a,b) => b.count - a.count).slice(0,3);
                    return { count: events.value.length, totalSpent: spent, topArtists: top };
                });

                const formatMoney = (v) => v?.toLocaleString() || '0';
                const getEventColor = (e) => e.color || themeColor.value;
                const getTicketPrice = (ex) => ex?.filter(i => i.item.includes('é–€ç¥¨')).reduce((s,i) => s + Number(i.amount), 0) || 0;
                const calculateFandomDays = (d) => { if(!d) return 0; const diff = new Date() - new Date(d); return Math.floor(diff/86400000) + 1; };

                const showTicket = (e) => { ticketEvent.value = e; showTicketModal.value = true; };
                const openFandomModal = () => { showFandomModal.value = true; };
                const closeFandomModal = () => { showFandomModal.value = false; };
                const addFandom = () => { fandoms.value.push({...fandomForm.value}); localStorage.setItem('fandomFandoms', JSON.stringify(fandoms.value)); closeFandomModal(); };
                const removeFandom = (i) => { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { fandoms.value.splice(i,1); localStorage.setItem('fandomFandoms', JSON.stringify(fandoms.value)); } };

                // æ ¸å¿ƒï¼šä¿®å¾©å¾Œçš„æ“·å–é‚è¼¯
                const downloadTicketImage = async () => {
                    const el = document.getElementById('ticket-capture');
                    const canvas = await html2canvas(el, {
                        scale: 3,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: null,
                        logging: false
                    });
                    const link = document.createElement('a');
                    link.download = `Ticket_${ticketEvent.value.artist}_${ticketEvent.value.date}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                };

                const generateReviewImage = async () => {
                    const el = document.getElementById('stats-capture');
                    const canvas = await html2canvas(el, { scale: 3, backgroundColor: '#f8fafc' });
                    const link = document.createElement('a');
                    link.download = `è¿½æ˜Ÿå¹´åº¦å›é¡§.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };

                const downloadBackup = () => {
                    const blob = new Blob([JSON.stringify(events.value)], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob); a.download = 'idol_tracker_backup.json'; a.click();
                };

                return {
                    events, fandoms, activeTab, viewMode, themeColor, showTicketModal, showFandomModal, showSettingsModal, ticketEvent, isPrivacyMode, customTitle, fandomForm,
                    cssVars, headerTextColor, greetingMessage, filteredEvents, statsData, formatMoney, getEventColor, getTicketPrice, calculateFandomDays,
                    showTicket, openFandomModal, closeFandomModal, addFandom, removeFandom, downloadTicketImage, generateReviewImage, downloadBackup
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
