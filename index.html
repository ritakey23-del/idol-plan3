<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | V1.0.4 å®Œæ•´ä¿®å¾©ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Quicksand:wght@500;700&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #63b3b0; }
        body { background-color: #f8fafc; height: 100dvh; overflow: hidden; font-family: "Noto Sans TC", sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #map-container { height: 100%; width: 100%; z-index: 1; }
        .ticket-stub { background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), radial-gradient(circle at 100% 50%, transparent 10px, white 11px); background-size: 100% 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        .ticket-divider { border-top: 2px dashed #e2e8f0; position: relative; }
        .ticket-divider::before, .ticket-divider::after { content: ''; position: absolute; top: -10px; width: 20px; height: 20px; background-color: #1e293b; border-radius: 50%; }
        .ticket-divider::before { left: -30px; } .ticket-divider::after { right: -30px; }
    </style>
</head>
<body class="text-slate-700">
    <div id="app" :style="{'--primary-color': themeColor}" class="h-full flex flex-col relative w-full">
        <header class="pt-4 pb-4 px-5 shadow-lg rounded-b-[1.5rem] z-20 shrink-0 text-white transition-colors" :style="{ backgroundColor: themeColor }">
            <div class="flex justify-between items-center mb-3">
                <div><h1 class="text-xl font-bold">{{ customTitle }}</h1><p class="text-xs opacity-80">æ„›è®“å›æ†¶é–ƒé–ƒç™¼å…‰ âœ¨</p></div>
                <div class="bg-white/20 p-2 rounded-full cursor-pointer" @click="showSettingsModal = true"><i class="ph-bold ph-gear"></i></div>
            </div>
            <div class="flex gap-3" v-if="activeTab === 'home'">
                <div class="bg-white/20 rounded-xl p-2 flex-1 text-center"><div class="text-[10px]">å€’æ•¸ä¸­</div><div class="text-lg font-bold">{{ upcomingCount }} å ´</div></div>
                <div class="bg-white/20 rounded-xl p-2 flex-1 text-center"><div class="text-[10px]">å¹´åº¦èŠ±è²»</div><div class="text-lg font-bold">{{ isPrivacyMode ? '****' : '$' + formatMoney(currentYearExpense) }}</div></div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar relative bg-slate-50">
            <div v-if="activeTab === 'home'" class="p-5 pb-32 space-y-4">
                <input v-model="searchQuery" type="text" placeholder="æœå°‹è¡Œç¨‹..." class="w-full bg-white border rounded-xl py-2 px-4 text-sm shadow-sm outline-none">
                <div v-for="event in filteredEvents" :key="event.id" class="bg-white rounded-2xl shadow-sm border overflow-hidden" @click="expandedEventId = expandedEventId === event.id ? null : event.id">
                    <div v-if="event.coverUrl" class="h-32 w-full relative"><img :src="event.coverUrl" class="w-full h-full object-cover"></div>
                    <div class="p-4">
                        <div class="flex justify-between mb-2"><span class="text-xs font-bold px-2 py-1 rounded text-white" :style="{backgroundColor: event.color || themeColor}">{{ event.artist }}</span><button @click.stop="showTicket(event)" class="text-xs bg-slate-100 px-2 py-1 rounded">ç¥¨æ ¹</button></div>
                        <h3 class="font-bold text-slate-800">{{ event.title }}</h3>
                        <div class="text-xs text-slate-500 mt-2 flex items-center gap-2"><i class="ph-bold ph-calendar"></i> {{ event.date }} | <i class="ph-bold ph-map-pin"></i> {{ event.location }}</div>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'fandom'" class="p-5 pb-32 space-y-4">
                <div class="flex justify-between items-center"><h2 class="font-bold">å…¥å‘ç´€å¿µæ—¥ ğŸ’–</h2><button @click="openFandomModal" class="text-xs border rounded-full px-3 py-1">+ æ–°å¢</button></div>
                <div v-for="(fan, idx) in fandoms" :key="idx" class="bg-white p-4 rounded-2xl shadow-sm border relative overflow-hidden">
                    <div v-if="fan.coverUrl" class="h-32 -mx-4 -mt-4 mb-4"><img :src="fan.coverUrl" class="w-full h-full object-cover"></div>
                    <div class="flex justify-between font-bold"><h3>{{ fan.name }} {{ fan.sticker }}</h3><i class="ph-bold ph-trash text-slate-300" @click="removeFandom(idx)"></i></div>
                    <div class="text-center bg-slate-50 p-3 rounded-xl mt-3"><p class="text-sm">è¿½éš¨ç¬¬ <span class="text-2xl font-black text-primary">{{ calculateFandomDays(fan.date) }}</span> å¤©</p></div>
                </div>
            </div>

            <div v-show="activeTab === 'map'" class="h-full relative">
                <div id="map-container"></div>
                <div class="absolute top-4 left-4 right-4 z-[1000] bg-white/90 p-4 rounded-2xl shadow-lg border">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold">è¿½æ˜Ÿè¶³è·¡ ğŸ—ºï¸</h3>
                        <span class="text-[10px] bg-primary text-white px-2 py-1 rounded-full" v-if="travelMileage > 0">ç´¯ç©ç§»å‹• {{ travelMileage }} KM</span>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-1">å·²é»äº® {{ mappedEventsCount }} å€‹åœ°é»</p>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t px-6 py-3 flex justify-between items-center shrink-0 z-40 pb-safe">
            <button @click="activeTab = 'home'" :class="activeTab==='home'?'text-primary':'text-slate-400'"><i class="ph-bold ph-calendar-check text-2xl"></i></button>
            <button @click="activeTab = 'fandom'" :class="activeTab==='fandom'?'text-primary':'text-slate-400'"><i class="ph-bold ph-heart-straight text-2xl"></i></button>
            <button @click="activeTab = 'map'" :class="activeTab==='map'?'text-primary':'text-slate-400'"><i class="ph-bold ph-map-trifold text-2xl"></i></button>
        </nav>

        <div v-if="showSettingsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
            <div class="bg-white p-6 rounded-2xl w-full max-w-xs shadow-2xl">
                <h3 class="font-bold mb-4">è¨­å®š</h3>
                <input v-model="customTitle" class="w-full border rounded-lg p-2 mb-4 text-center font-bold">
                <div class="flex flex-col gap-2">
                    <button @click="downloadBackup" class="w-full py-2 bg-slate-100 rounded-lg text-sm">åŒ¯å‡ºå‚™ä»½ (JSON)</button>
                    <button @click="showSettingsModal = false" class="mt-2 text-slate-400 text-sm">é—œé–‰</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
        createApp({
            setup() {
                const events = ref(JSON.parse(localStorage.getItem('idolEvents') || '[]'));
                const fandoms = ref(JSON.parse(localStorage.getItem('fandomFandoms') || '[]'));
                const themeColor = ref(localStorage.getItem('idolTheme') || '#63b3b0');
                const activeTab = ref('home');
                const searchQuery = ref('');
                const travelMileage = ref(0);
                const isPrivacyMode = ref(false);
                const customTitle = ref(localStorage.getItem('appTitle') || 'è¿½æ˜Ÿæ—¥è¨˜ âœ¨');
                const showSettingsModal = ref(false);
                let map = null, markers = [];

                const formatMoney = (v) => v?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") || '0';
                const calculateFandomDays = (d) => d ? Math.floor((new Date() - new Date(d)) / 86400000) + 1 : 0;

                const initMap = () => {
                    if (!map) { map = L.map('map-container').setView([23.6, 120.9], 7); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); }
                    else { map.invalidateSize(); }
                    markers.forEach(m => map.removeLayer(m)); markers = [];
                    const path = events.value.filter(e => e.lat && e.lng).sort((a,b) => new Date(a.date) - new Date(b.date));
                    const coords = []; let dist = 0;
                    path.forEach((e, i) => {
                        const m = L.circleMarker([e.lat, e.lng], {radius: 6, fillColor: e.color || themeColor.value, color: '#fff', weight: 2, fillOpacity: 0.8}).addTo(map);
                        markers.push(m); coords.push([e.lat, e.lng]);
                        if (i > 0) dist += L.latLng(coords[i-1]).distanceTo(L.latLng(coords[i]));
                    });
                    if (coords.length > 1) { markers.push(L.polyline(coords, {color: themeColor.value, weight: 3, opacity: 0.5, dashArray: '8,12'}).addTo(map)); }
                    travelMileage.value = (dist / 1000).toFixed(1);
                    if (coords.length > 0) map.fitBounds(coords, {padding: [50, 50]});
                };

                watch(events, (v) => localStorage.setItem('idolEvents', JSON.stringify(v)), {deep: true});
                watch(activeTab, (v) => { if (v === 'map') nextTick(initMap); });

                return {
                    events, fandoms, themeColor, activeTab, searchQuery, travelMileage, isPrivacyMode, customTitle, showSettingsModal,
                    formatMoney, calculateFandomDays,
                    upcomingCount: computed(() => events.value.filter(e => e.date >= new Date().toISOString().split('T')[0]).length),
                    currentYearExpense: computed(() => events.value.reduce((s, e) => s + (e.expenses?.reduce((ss, i) => ss + Number(i.amount||0), 0) || 0), 0)),
                    filteredEvents: computed(() => events.value.filter(e => e.title.includes(searchQuery.value) || e.artist.includes(searchQuery.value))),
                    mappedEventsCount: computed(() => events.value.filter(e => e.lat && e.lng).length),
                    downloadBackup: () => { const b = new Blob([JSON.stringify({events: events.value, fandoms: fandoms.value})], {type: 'application/json'}); const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'backup.json'; a.click(); },
                    removeFandom: (i) => { fandoms.value.splice(i, 1); localStorage.setItem('fandomFandoms', JSON.stringify(fandoms.value)); }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
