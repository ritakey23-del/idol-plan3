<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çš„è¿½æ˜Ÿæ—¥è¨˜ ğŸŒŸ | ç­‰ç´šèˆ‡æˆå°±ç‰ˆ</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/bold/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/fill/style.css" />
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Quicksand:wght@500;700&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">

    <style>
        :root { --primary-color: #63b3b0; }
        body { background-color: #f8fafc; font-family: "Noto Sans TC", sans-serif; height: 100dvh; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .ticket-stub {
            background-image: radial-gradient(circle at 0 50%, transparent 10px, white 11px), radial-gradient(circle at 100% 50%, transparent 10px, white 11px);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        .slide-up-enter-active, .slide-up-leave-active { transition: all 0.3s ease-out; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-slate-700 antialiased flex flex-col">

    <div id="app" class="h-full flex flex-col relative w-full">

        <header :style="{ backgroundColor: themeColor }" class="pt-4 pb-4 px-5 shadow-lg rounded-b-[1.5rem] z-20 shrink-0 text-white">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 class="text-xl font-bold tracking-wide">{{ customTitle }}</h1>
                    <p class="text-xs opacity-80">{{ greetingMessage }}</p>
                </div>
                <div class="bg-white/20 p-2 rounded-full cursor-pointer" @click="showSettingsModal = true">
                    <i class="ph ph-gear text-lg"></i>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto no-scrollbar p-5 pb-32 bg-slate-50">
            
            <div v-if="activeTab === 'home'" class="space-y-4">
                <div class="flex bg-slate-200 p-1 rounded-full mb-4">
                    <button @click="viewMode = 'upcoming'" :class="viewMode === 'upcoming' ? 'bg-white shadow-sm' : ''" class="flex-1 py-2 text-sm font-medium rounded-full transition-all">å³å°‡åˆ°ä¾†</button>
                    <button @click="viewMode = 'history'" :class="viewMode === 'history' ? 'bg-white shadow-sm' : ''" class="flex-1 py-2 text-sm font-medium rounded-full transition-all">ç¾å¥½å›æ†¶</button>
                </div>

                <div v-for="event in filteredEvents" :key="event.id" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-[10px] font-bold px-2 py-0.5 rounded text-white" :style="{ backgroundColor: event.color || themeColor }">{{ event.artist }}</span>
                            <h3 class="text-lg font-bold mt-1">{{ event.title }}</h3>
                            <p class="text-sm text-slate-500 flex items-center gap-1 mt-1"><i class="ph ph-calendar"></i> {{ event.date }} {{ event.time }}</p>
                            <p class="text-sm text-slate-500 flex items-center gap-1"><i class="ph ph-map-pin"></i> {{ event.location }}</p>
                        </div>
                        <button @click="showTicket(event)" class="text-primary text-2xl"><i class="ph ph-ticket"></i></button>
                    </div>
                </div>
            </div>

            <div v-if="activeTab === 'fandom'" class="space-y-4">
                <div v-for="fan in fandoms" class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                    <div class="p-4">
                        <h3 class="text-xl font-bold">{{ fan.name }} {{ fan.sticker }}</h3>
                        <p class="text-sm text-slate-500">å…¥å‘ç¬¬ <span class="text-primary font-bold text-lg">{{ calculateFandomDays(fan.date) }}</span> å¤©</p>
                    </div>
                </div>
                <button @click="openFandomModal" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold">+ æ–°å¢å…¥å‘æ—¥</button>
            </div>

            <div v-if="activeTab === 'stats'" class="space-y-6">
                <div :class="['rounded-3xl p-6 text-white shadow-xl relative overflow-hidden bg-gradient-to-br', userLevelData.color]">
                    <div class="absolute -right-4 -top-4 opacity-10 rotate-12"><i class="ph ph-crown text-9xl"></i></div>
                    <div class="flex items-center gap-4 relative z-10">
                        <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-md flex items-center justify-center text-4xl shadow-inner">{{ userLevelData.icon }}</div>
                        <div class="flex-1">
                            <div class="flex items-baseline gap-2">
                                <h3 class="font-bold text-xl">{{ userLevelData.title }}</h3>
                                <span class="text-xs opacity-80">LV.{{ userLevelData.level }}</span>
                            </div>
                            <div class="mt-4">
                                <div class="flex justify-between text-[10px] mb-1 font-mono opacity-90">
                                    <span>XP: {{ userLevelData.totalXP }}</span>
                                    <span>é‚„å·® {{ userLevelData.nextLevelXP }} å‡ç´š</span>
                                </div>
                                <div class="h-2 w-full bg-black/20 rounded-full overflow-hidden">
                                    <div class="h-full bg-white transition-all duration-1000" :style="{ width: userLevelData.progress + '%' }"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2"><i class="ph ph-medal"></i> å·²è§£é–æˆå°±</h3>
                    <div class="grid grid-cols-4 gap-4">
                        <div v-for="ach in achievements" class="flex flex-col items-center">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center mb-1" :style="{ backgroundColor: ach.color + '20', color: ach.color }">
                                <i :class="['ph text-2xl', ach.icon]"></i>
                            </div>
                            <span class="text-[10px] font-bold text-slate-600">{{ ach.name }}</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400">ç´¯è¨ˆå ´æ¬¡</p>
                        <p class="text-2xl font-bold">{{ events.length }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400">ç¸½æŠ•è³‡é¡</p>
                        <p class="text-2xl font-bold">${{ formatMoney(totalSpent) }}</p>
                    </div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full bg-white border-t border-slate-100 px-6 py-3 flex justify-between items-center safe-pb z-40">
            <button @click="activeTab = 'home'" :class="activeTab === 'home' ? 'text-primary' : 'text-slate-400'" class="flex flex-col items-center gap-1">
                <i class="ph ph-calendar-check text-2xl"></i><span class="text-[10px]">è¡Œç¨‹</span>
            </button>
            <button @click="activeTab = 'fandom'" :class="activeTab === 'fandom' ? 'text-primary' : 'text-slate-400'" class="flex flex-col items-center gap-1">
                <i class="ph ph-heart text-2xl"></i><span class="text-[10px]">ç´€å¿µæ—¥</span>
            </button>
            <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'text-primary' : 'text-slate-400'" class="flex flex-col items-center gap-1">
                <i class="ph ph-chart-bar text-2xl"></i><span class="text-[10px]">å›é¡§</span>
            </button>
        </nav>

        <button v-if="activeTab === 'home'" @click="openModal" class="fixed bottom-24 right-6 w-14 h-14 bg-primary text-white rounded-full shadow-lg flex items-center justify-center text-2xl z-30 shadow-primary/40">
            <i class="ph ph-plus"></i>
        </button>

        <transition name="slide-up">
            <div v-if="showModal" class="fixed inset-0 z-50 flex items-end justify-center bg-black/40 backdrop-blur-sm">
                <div class="bg-white w-full max-w-md rounded-t-3xl p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold">æ–°å¢è¿½æ˜Ÿè¡Œç¨‹</h2>
                    <input v-model="form.title" type="text" placeholder="æ´»å‹•åç¨±" class="w-full p-3 bg-slate-100 rounded-xl outline-none">
                    <input v-model="form.artist" type="text" placeholder="æ­Œæ‰‹/åœ˜é«”" class="w-full p-3 bg-slate-100 rounded-xl outline-none">
                    <input v-model="form.date" type="date" class="w-full p-3 bg-slate-100 rounded-xl outline-none">
                    <input v-model="form.location" type="text" placeholder="åœ°é»" class="w-full p-3 bg-slate-100 rounded-xl outline-none">
                    <textarea v-model="form.memo" placeholder="å¯«ä¸‹å¿ƒå¾— (æ»¿ 20 å­—åŠ  XP)" class="w-full p-3 bg-slate-100 rounded-xl h-24 outline-none"></textarea>
                    <button @click="saveEvent" class="w-full py-4 bg-primary text-white font-bold rounded-xl">å„²å­˜è¡Œç¨‹</button>
                    <button @click="showModal = false" class="w-full text-slate-400 text-sm">å–æ¶ˆ</button>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const events = ref(JSON.parse(localStorage.getItem('idolEvents') || '[]'));
                const fandoms = ref(JSON.parse(localStorage.getItem('fandomFandoms') || '[]'));
                const activeTab = ref('home');
                const viewMode = ref('upcoming');
                const themeColor = ref('#63b3b0');
                const customTitle = ref('è¿½æ˜Ÿæ—¥è¨˜ âœ¨');
                const showModal = ref(false);
                const form = ref({ title: '', artist: '', date: '', location: '', memo: '', checklist: [] });

                // ç­‰ç´šç®—æ³•
                const userLevelData = computed(() => {
                    let xp = 0;
                    xp += events.value.length * 100; // æ¯å ´ 100
                    xp += new Set(events.value.map(e => e.artist)).size * 50; // æ–°è—äºº 50
                    events.value.forEach(e => {
                        if (e.memo && e.memo.length > 20) xp += 30; // å¿ƒå¾— 30
                    });
                    fandoms.value.forEach(f => {
                        const days = Math.floor((new Date() - new Date(f.date)) / (1000*60*60*24));
                        xp += Math.floor(days / 365) * 200; // è³‡æ­·æ¯å¹´ 200
                    });

                    const lv = Math.max(1, Math.floor(Math.sqrt(xp / 100)));
                    const baseXP = Math.pow(lv, 2) * 100;
                    const nextXP = Math.pow(lv + 1, 2) * 100;
                    const prog = ((xp - baseXP) / (nextXP - baseXP)) * 100;

                    const ranks = [
                        { lv: 40, title: "å‚³å¥‡å¤§ç ²æ‰‹", icon: "ğŸ“¸", color: "from-purple-600 to-pink-500" },
                        { lv: 20, title: "éˆé­‚æ‡‰æ´å®¶", icon: "ğŸ’", color: "from-blue-500 to-cyan-400" },
                        { lv: 10, title: "å ´é¤¨å·¡èˆªå“¡", icon: "ğŸš€", color: "from-amber-500 to-orange-400" },
                        { lv: 4,  title: "æ‡‰æ´å°éšŠé•·", icon: "ğŸ“£", color: "from-emerald-500 to-teal-400" },
                        { lv: 0,  title: "è¦‹ç¿’è¿½æ˜Ÿäºº", icon: "ğŸŒ±", color: "from-slate-600 to-slate-500" }
                    ];
                    const currentRank = ranks.find(r => lv >= r.lv);
                    return { level: lv, totalXP: xp, progress: prog, nextLevelXP: nextXP - xp, ...currentRank };
                });

                // æˆå°±ç³»çµ±
                const achievements = computed(() => {
                    const list = [];
                    if (events.value.length >= 1) list.push({ name: 'åˆå¿ƒè¦‹è­‰', icon: 'ph-sparkle', color: '#63b3b0' });
                    if (new Set(events.value.map(e => e.location)).size >= 5) list.push({ name: 'è¶³è·¡éé‡', icon: 'ph-map-pin', color: '#ff6b6b' });
                    if (events.value.length >= 10) list.push({ name: 'è³‡æ·±æ‡‰æ´', icon: 'ph-crown', color: '#feca57' });
                    return list;
                });

                const filteredEvents = computed(() => {
                    const today = new Date().toISOString().split('T')[0];
                    return events.value.filter(e => viewMode.value === 'upcoming' ? e.date >= today : e.date < today);
                });

                const totalSpent = computed(() => 0); // é€™è£¡å¯è‡ªè¡ŒåŠ å…¥è²»ç”¨è¨ˆç®—é‚è¼¯

                const saveEvent = () => {
                    events.value.push({ ...form.value, id: Date.now() });
                    localStorage.setItem('idolEvents', JSON.stringify(events.value));
                    showModal.value = false;
                    form.value = { title: '', artist: '', date: '', location: '', memo: '', checklist: [] };
                };

                const calculateFandomDays = (d) => Math.floor((new Date() - new Date(d)) / (1000*60*60*24)) || 0;
                const formatMoney = (v) => v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                const openModal = () => showModal.value = true;

                return {
                    events, fandoms, activeTab, viewMode, themeColor, customTitle, showModal, form,
                    userLevelData, achievements, filteredEvents, totalSpent,
                    saveEvent, calculateFandomDays, formatMoney, openModal,
                    greetingMessage: "ä»Šå¤©ä¹Ÿè¦ç‚ºæ„›å¥”è·‘ï¼âœ¨"
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
